rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Default: read-only unless explicitly allowed
    match /{document=**} {
      allow read: if true;
      allow write: if false;
    }

    // ===== HELPER FUNCTIONS FOR ROLE-BASED ACCESS =====
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get current user's data
    function getCurrentUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user has admin role
    function isAdmin() {
      return isAuthenticated() && getCurrentUser().role == 'admin';
    }
    
    // Check if user has specific permission
    function hasPermission(permission) {
      return isAuthenticated() && getCurrentUser().permissions[permission] == true;
    }
    
    // Check if user is team owner (has no parentId or is admin)
    function isTeamOwner() {
      return isAuthenticated() && 
        (getCurrentUser().parentId == '' || getCurrentUser().parentId == null || isAdmin());
    }
    
    // Check if user belongs to the same team (same parentId or is admin)
    function isTeamMember(targetUserId) {
      return isAuthenticated() && 
        (getCurrentUser().parentId == get(/databases/$(database)/documents/users/$(targetUserId)).data.parentId || isAdmin());
    }

    // ===== EXISTING COLLECTIONS (PRESERVED) =====

    // Raw analytics events: allow public create (no update/delete)
    match /analytics-events/{eventId} {
      allow create: if true;
      allow read, update, delete: if false;
    }

    // Aggregated analytics: allow constrained updates by any client for recent dates
    match /analytics-aggregated/{dateKey} {
      allow read: if true;

      // Only allow subcollection docs to be created/updated when a housekeeping field exists
      match /menus/{menuId} {
        allow create, update: if isAggregateWrite();
        allow delete: if false;
      }
      match /items/{itemId} {
        allow create, update: if isAggregateWrite();
        allow delete: if false;
      }
      match /categories/{categoryId} {
        allow create, update: if isAggregateWrite();
        allow delete: if false;
      }
      match /specials/{specialId} {
        allow create, update: if isAggregateWrite();
        allow delete: if false;
      }

      function isAggregateWrite() {
        // Minimal guard: require presence of lastUpdated field
        return request.resource.data.keys().hasAll(['lastUpdated']);
      }
    }

    // Reviews collection - unified per-menu-item reviews with anonymous create and admin moderation
    match /reviews/{reviewId} {
      allow read: if true;

      // Anonymous creates allowed with strict validation and whitelisted fields
      function isCreateValid() {
        let allowed = ['menuItemId','customerName','message','rating','status','createdAt','restaurantId','ownerId'];
        return request.resource.data.keys().hasOnly(allowed)
          && request.resource.data.menuItemId is string && request.resource.data.menuItemId.size() > 0
          && request.resource.data.customerName is string && request.resource.data.customerName.size() >= 2
          && request.resource.data.message is string && request.resource.data.message.size() >= 10
          && request.resource.data.rating is int && request.resource.data.rating >= 1 && request.resource.data.rating <= 5
          && request.resource.data.status == 'pending';
      }

      // Anyone can create if it passes validation (no auth required)
      allow create: if isCreateValid();

      // Only users with manageUsers permission may moderate status/notes fields
      allow update: if hasPermission('manageUsers')
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status','moderatedBy','moderatedAt','moderationNotes']);

      allow delete: if hasPermission('manageUsers');
    }
    
    // Review stats collection
    match /reviewStats/{menuItemId} {
      allow read: if true;
      allow write: if false; // Only updated by backend
    }
    
    // Media collection - rules for media library
    match /media/{mediaId} {
      allow read: if isAuthenticated();
      // Authenticated users can create media docs with required fields
      allow create: if isAuthenticated() 
        && request.resource.data.fileName is string && request.resource.data.fileName.size() > 0
        && request.resource.data.originalName is string && request.resource.data.originalName.size() > 0
        && request.resource.data.fileSize is int && request.resource.data.fileSize > 0
        && request.resource.data.fileSize <= 10485760 // 10MB max
        && request.resource.data.mimeType is string && request.resource.data.mimeType.matches('image/.*');
      // Authenticated users can update
      allow update: if isAuthenticated();
      // Authenticated users can delete
      allow delete: if isAuthenticated();
    }
    
    // Media usage collection - tracks where media is used
    match /media_usage/{usageId} {
      allow read: if isAuthenticated();
      // Authenticated users can create with basic validation
      allow create: if isAuthenticated()
        && request.resource.data.mediaId is string
        && request.resource.data.componentId is string
        && request.resource.data.componentType is string
        && request.resource.data.componentName is string
        && request.resource.data.usageDate != null;
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // Specials collection - users with addSpecials permission can manage
    match /specials/{specialId} {
      allow read: if true;
      allow create: if hasPermission('addSpecials');
      allow update: if hasPermission('addSpecials');
      allow delete: if hasPermission('addSpecials');
    }

    // Restaurants collection - users with editRestaurants permission can manage
    match /restuarants/{restaurantId} {
      allow read: if isAuthenticated();
      allow create: if hasPermission('editRestaurants');
      allow update: if hasPermission('editRestaurants');
      allow delete: if hasPermission('editRestaurants');
    }

    // Orders collection - allow read for authenticated users; writes are system-managed
    match /orders/{orderId} {
      allow read: if isAuthenticated();
      allow write: if false;
    }

    // Branding collections - users with editBranding permission can manage
    match /branding/{brandingId} {
      allow read: if true;
      allow create: if hasPermission('editBranding');
      allow update: if hasPermission('editBranding');
      allow delete: if hasPermission('editBranding');
    }

    // Menus collection - users with appropriate permissions can manage
    match /menus/{menuId} {
      allow read: if true;
      allow create: if hasPermission('createMenus');
      allow update: if hasPermission('editMenus');
      allow delete: if hasPermission('editMenus');
    }

    match /branding-preview/{previewId} {
      allow read: if true;
      allow create: if hasPermission('editBranding');
      allow update: if hasPermission('editBranding');
      allow delete: if hasPermission('editBranding');
    }

    // ===== ENHANCED USER MANAGEMENT =====

    // Users collection - enhanced for team management
    match /users/{uid} {
      // Users can read their own profile or team members' profiles (if they have manageUsers permission)
      allow read: if isAuthenticated() && 
        (request.auth.uid == uid || (hasPermission('manageUsers') && isTeamMember(uid)));
      
      // Users can create their own profile during signup
      allow create: if isAuthenticated() && request.auth.uid == uid;
      
      // Users can update their own profile or team members' profiles (if they have manageUsers permission)
      allow update: if isAuthenticated() && 
        (request.auth.uid == uid || (hasPermission('manageUsers') && isTeamMember(uid)));
      
      // Only team owners or admins can delete users
      allow delete: if isAuthenticated() && 
        (isTeamOwner() || isAdmin()) && isTeamMember(uid);
    }

    // ===== NEW COLLECTIONS FOR USER MANAGEMENT =====

    // Invitations collection - for managing user invitations
    match /invitations/{invitationToken} {
      // Only team owners or admins can create invitations
      allow create: if isAuthenticated() && (isTeamOwner() || isAdmin());
      
      // Only the inviter or the invited user can read the invitation
      allow read: if isAuthenticated() && 
        (resource.data.invitedBy == request.auth.uid || 
         resource.data.email == getCurrentUser().email);
      
      // Only the invited user can update (accept) the invitation
      allow update: if isAuthenticated() && 
        resource.data.email == getCurrentUser().email &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'acceptedAt']);
      
      // Only team owners or admins can delete invitations
      allow delete: if isAuthenticated() && (isTeamOwner() || isAdmin());
    }

    // Notification collection - allow authenticated users to manage notifications
    match /notification/{notifId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }
  }
}