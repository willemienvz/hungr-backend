# Critical Security Vulnerability: Media Library Cross-User Access

**Date Identified**: October 21, 2025  
**Severity**: HIGH  
**Status**: Identified, Fix Prepared  
**Affected**: All media documents in Firestore

---

## Vulnerability Description

### Current State (VULNERABLE)

**File**: `backend/firestore.rules` (Line 35)

```javascript
// Media library - users can only access their own media
match /media/{mediaId} {
  // Allow read for authenticated users (needed for queries with orderBy)
  allow read: if isAuthenticated();  // ❌ TOO PERMISSIVE!
  // ... other rules
}
```

### The Problem

**Line 35 allows ANY authenticated user to read ALL media documents**, regardless of ownership.

While the comment says "users can only access their own media", the actual rule implementation allows:
- ✅ Any authenticated user can read ALL media documents
- ✅ User A can read User B's private media
- ✅ User A can query the entire media collection
- ✅ Direct Firestore SDK queries bypass application-level filtering

### Attack Vector

A malicious user could bypass the application and query Firestore directly:

```javascript
// This would return ALL media from ALL users (with current rules)
firebase.firestore()
  .collection('media')
  .get()
  .then(snapshot => {
    console.log(`Found ${snapshot.size} media documents`);
    // User can see ALL media from ALL users!
  });
```

### Why This Happened

The comment mentions "needed for queries with orderBy" - likely the rules were opened up to allow queries with sorting, but this went too far and exposed all documents.

**Defense in Depth Failure**: The application code (media-library.service.ts) correctly filters by userId, but this is NOT a security layer since users can bypass the application.

---

## Impact Assessment

### Data Exposure Risk

- **Confidentiality**: HIGH - Users can view other users' private media
- **Integrity**: LOW - Update/delete rules are correct
- **Availability**: NONE - No data loss risk

### Compliance Risk

- **Privacy Regulations**: Potential GDPR/CCPA violation (cross-user data access)
- **Platform Terms**: May violate Firebase security best practices

### Business Risk

- **Trust**: Users expect their media to be private
- **Reputation**: Discovery could damage platform credibility
- **Legal**: Potential liability for data privacy breach

---

## The Fix

### Updated Rules (SECURE)

**File**: `backend/firestore.rules` (Line 35)

**BEFORE** (Vulnerable):
```javascript
allow read: if isAuthenticated();
```

**AFTER** (Secure):
```javascript
allow read: if isAuthenticated() && 
  (resource.data.userId == request.auth.uid ||
   resource.data.ownerId == request.auth.uid ||
   resource.data.uploadedBy == request.auth.uid);
```

### Why This Fixes It

1. **Authentication + Authorization**: User must be authenticated AND own the document
2. **Backward Compatible**: Supports userId, ownerId, and uploadedBy fields
3. **Defense in Depth**: Enforces security at database level, not just application
4. **Query Support**: Still allows orderBy queries when properly filtered by application

### Query Impact

**Application queries will still work** because they already filter by userId:

```typescript
// This query already filters by userId (media-library.service.ts, line 273)
this.mediaCollection.ref.where('userId', '==', user.uid)
```

The new rule simply enforces that users **cannot bypass** this filtering.

---

## Deployment Plan

### Prerequisites (CRITICAL)

1. ✅ **T010**: Audit all media documents for owner fields
   - Run: `ts-node scripts/audit-media-ownership.ts`
   - Verify: All documents have userId/ownerId/uploadedBy
   - If missing: Run migration before deploying rules

2. ✅ **T002**: Backup current rules (ALREADY DONE)
   - Backup created: `firestore.rules.backup-*`
   - Can rollback if issues detected

### Testing Plan

1. **T007-T009**: Create security tests (demonstrate vulnerability)
2. **T011**: Update Firestore rules
3. **T012**: Test in Firebase emulator (verify fix works)
4. **T013**: Deploy to staging (if exists)
5. **T014**: Verify queries still work
6. **T015**: Deploy to production
7. **T016**: Multi-user verification in production

### Rollback Plan

If issues detected after deployment:

```bash
# Immediate rollback
firebase deploy --only firestore:rules --force

# Use backup file
cp firestore.rules.backup-YYYYMMDD-HHMMSS firestore.rules
firebase deploy --only firestore:rules
```

---

## Verification Checklist

Before marking as complete:

- [ ] All media documents audited (T010)
- [ ] Security tests created and fail with current rules (T007-T009)
- [ ] Firestore rules updated (T011)
- [ ] Tests pass in emulator (T012)
- [ ] Staging deployment successful (T013)
- [ ] Queries verified working (T014)
- [ ] Production deployment successful (T015)
- [ ] Multi-user verification complete (T016)
- [ ] No increase in permission denied errors
- [ ] Media library loads correctly for all users

---

## Lessons Learned

1. **Never rely solely on application-level security** - Always enforce at database level
2. **Comments can lie** - The comment said "users can only access their own media" but code didn't match
3. **Test with multiple accounts** - Security issues often only appear in multi-user scenarios
4. **orderBy doesn't require permissive reads** - Can filter by user AND use orderBy
5. **Defense in depth works** - Application filtering prevented actual exploitation, but rules must match

---

## References

- **Security Contract**: `/specs/002-specify-scripts-bash/contracts/security.contract.js`
- **Research Document**: `/specs/002-specify-scripts-bash/research.md` (Section 4)
- **Implementation Plan**: `/specs/002-specify-scripts-bash/plan.md` (Phase 2)
- **Firebase Documentation**: https://firebase.google.com/docs/firestore/security/rules-conditions

---

**Status**: Fix prepared, awaiting deployment  
**Next Step**: Run audit script (T010), then deploy fix (T011-T016)













