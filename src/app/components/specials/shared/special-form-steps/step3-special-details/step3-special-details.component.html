<div class="step3-container block-open-top">
  <ng-content select="[header]"></ng-content>

  <app-content-block title="" customClass="rowSpecial block-open-top">
    <form [formGroup]="specialForm">
      <!-- Percentage Discount -->
      <div *ngIf="selectedSpecialType === SpecialType.PERCENTAGE_DISCOUNT"  class="inputHolder">
        <div class="row">
          <div class="fieldHolder field field-grow full-width">
            <label>Search and select menu items</label>
            <mat-form-field>
              <input
                matInput
                type="text"
                [formControl]="menuItemAutocompleteControl"
                [matAutocomplete]="auto"
              />
              <mat-autocomplete
                #auto="matAutocomplete"
                [displayWith]="displayFn"
                (optionSelected)="onMenuItemSelected($event)"
              >
                <mat-option
                  *ngFor="let menuItem of filteredMenuItems | async"
                  [value]="menuItem"
                >
                  <span>{{ menuItem.name }}</span>
                </mat-option>

                <!-- Show no results message when no items match -->
                <mat-option
                  *ngIf="(filteredMenuItems | async)?.length === 0"
                  class="no-results-option"
                  disabled
                >
                  <span class="no-results-text">No menu items found</span>
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </div>

          <div class="fieldHolder field field-shrink compact-field">
            <label>Percentage discount</label>
            <div class="percentage-input-wrapper">
              <mat-form-field>
                <input
                  matInput
                  type="number"
                  min="0"
                  max="100"
                  formControlName="percentage"
                  (keydown.enter)="onAddItem()"
                />
                <span matSuffix class="percentage-suffix">%</span>
              </mat-form-field>
              <button 
                type="button"
                class="add-item-btn"
                (click)="onAddItem()"
                [disabled]="!canAddItem()">
                <i class="material-icons">add</i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Price Discount (Add Mode) -->
      <div *ngIf="selectedSpecialType === SpecialType.PRICE_DISCOUNT && !editMode" class="inputHolder">
        <div class="row">
          <div class="fieldHolder field field-grow full-width">
            <label>Search and select menu items</label>
            <mat-form-field>
              <input
                matInput
                type="text"
                [formControl]="menuItemAutocompleteControl"
                [matAutocomplete]="auto"
              />
              <mat-autocomplete
                #auto="matAutocomplete"
                [displayWith]="displayFn"
                (optionSelected)="onMenuItemSelected($event)"
              >
                <mat-option
                  *ngFor="let menuItem of filteredMenuItems | async"
                  [value]="menuItem"
                >
                  <span>{{ menuItem.name }}</span>
                </mat-option>

                <!-- Show no results message when no items match -->
                <mat-option
                  *ngIf="(filteredMenuItems | async)?.length === 0"
                  class="no-results-option"
                  disabled
                >
                  <span class="no-results-text">No menu items found</span>
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </div>

          <div class="fieldHolder field field-shrink compact-field">
            <label>Price</label>
            <div class="percentage-input-wrapper">
              <app-price-input
                class="compact"
                formControlName="amount"
                placeholder="R 0.00"
                label=""
                [required]="true"
                (keydown.enter)="onAddItem()">
              </app-price-input>
              <button 
                type="button"
                class="add-item-btn"
                (click)="onAddItem()"
                [disabled]="!canAddItem()">
                <i class="material-icons">add</i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Price Discount (Edit Mode) -->
      <div *ngIf="selectedSpecialType === SpecialType.PRICE_DISCOUNT && editMode"  class="inputHolder">
        <div class="row">
          <div class="fieldHolder field field-grow full-width">
            <app-form-select
              label="Item"
              placeholder="Select an item..."
              [options]="menuItemOptions"
              formControlName="typeSpecialDetails">
            </app-form-select>
          </div>
          <div class="fieldHolder field field-shrink compact-field">
            <label>Price</label>
            <div class="percentage-input-wrapper">
              <app-price-input
                class="compact"
                formControlName="amount"
                placeholder="R 0.00"
                label=""
                [required]="true"
                (keydown.enter)="onAddItem()">
              </app-price-input>
              <button 
                type="button"
                class="add-item-btn"
                (click)="onAddItem()"
                [disabled]="!canAddItem()">
                <i class="material-icons">add</i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Category Special -->
      <div *ngIf="selectedSpecialType === SpecialType.CATEGORY_SPECIAL" class="inputHolder">
        <!-- Category Selection and Discount in Row -->
        <div class="row">
          <div class="fieldHolder field field-grow full-width">
            <app-form-select
              label="Select a category"
              placeholder="Select category..."
              [options]="categoryOptions"
              formControlName="selectedCategory"
              [multiple]="false">
            </app-form-select>
          </div>

          <div class="fieldHolder field field-shrink compact-field">
            <!-- Percentage Discount -->
            <div *ngIf="specialForm.get('discountType')?.value === 'percentage'" class="discount-input-wrapper">
              <label>Percentage discount</label>
              <div class="percentage-input-wrapper">
                <!-- Discount Type Toggle -->
                <div class="discount-type-toggle">
                  <button
                    type="button"
                    class="toggle-btn"
                    [class.active]="specialForm.get('discountType')?.value === 'percentage'"
                    (click)="setDiscountType('percentage')">
                    %
                  </button>
                  <button
                    type="button"
                    class="toggle-btn"
                    [class.active]="specialForm.get('discountType')?.value === 'fixed'"
                    (click)="setDiscountType('fixed')">
                    R
                  </button>
                </div>
                <mat-form-field>
                  <input
                    matInput
                    type="number"
                    min="0"
                    max="100"
                    formControlName="amount"
                    (keydown.enter)="onAddItem()"
                  />
                  <span matSuffix class="percentage-suffix">%</span>
                </mat-form-field>
                <button 
                  type="button"
                  class="add-item-btn"
                  (click)="onAddItem()"
                  [disabled]="!canAddItem()">
                  <i class="material-icons">add</i>
                </button>
              </div>
            </div>

            <!-- Fixed Price Discount -->
            <div *ngIf="specialForm.get('discountType')?.value === 'fixed'" class="discount-input-wrapper">
              <label>Price Discount</label>
              <div class="percentage-input-wrapper">
                <!-- Discount Type Toggle -->
                <div class="discount-type-toggle">
                  <button
                    type="button"
                    class="toggle-btn"
                    [class.active]="specialForm.get('discountType')?.value === 'percentage'"
                    (click)="setDiscountType('percentage')">
                    %
                  </button>
                  <button
                    type="button"
                    class="toggle-btn"
                    [class.active]="specialForm.get('discountType')?.value === 'fixed'"
                    (click)="setDiscountType('fixed')">
                    R
                  </button>
                </div>
                <app-price-input
                  class="compact"
                  formControlName="amount"
                  placeholder="R 0.00"
                  label=""
                  [required]="true"
                  (keydown.enter)="onAddItem()">
                </app-price-input>
                <button 
                  type="button"
                  class="add-item-btn"
                  (click)="onAddItem()"
                  [disabled]="!canAddItem()">
                  <i class="material-icons">add</i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Combo Special -->
      <div *ngIf="selectedSpecialType === SpecialType.COMBO_DEAL" class="inputHolder">
        <!-- Items in combo - Full width -->
        <div class="fieldHolder field field-grow full-width combo-items-full-width">
          <app-form-select
            label="Items in combo"
            placeholder="Select items..."
            [options]="menuItemOptions"
            formControlName="typeSpecialDetails"
            [multiple]="true">
          </app-form-select>
        </div>

        <!-- Percentage discount -->
        <div class="fieldHolder field field-shrink compact-field combo-discount-field">
          <label>Percentage discount</label>
          <div class="percentage-input-wrapper">
            <mat-form-field>
              <input
                matInput
                type="number"
                min="0"
                max="100"
                formControlName="percentage"
                (keydown.enter)="onAddItem()"
              />
              <span matSuffix class="percentage-suffix">%</span>
            </mat-form-field>
            <button 
              type="button"
              class="add-item-btn"
              (click)="onAddItem()"
              [disabled]="!canAddItem()">
              <i class="material-icons">add</i>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Display List of Added Items -->
      <div *ngIf="addedItems.length > 0" class="item-list">
        <p class="item-list-title">Items</p>
        <div class="list" *ngFor="let item of addedItems; let i = index">
          <div class="left">
            <button type="button" class="btnRemove" (click)="onRemoveItem(i)" aria-label="Remove item">Ã—</button>
            <p class="item-name">{{ item.name }}</p>
          </div>
          <p class="item-amount">{{ item.amount }}</p>
        </div>
      </div>
    </form>
  </app-content-block>
</div> 